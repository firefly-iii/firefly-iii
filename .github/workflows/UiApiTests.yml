




name: UI + API + Parser Tests

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  # === 1) UI (◊õ◊ë◊® ◊¢◊ë◊ì ◊ú◊ö) ===
  ui-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      FIREFLY_URL: "http://54.217.40.63:8080"
      EMAIL: ${{ secrets.FIREFLY_EMAIL }}
      PASSWORD: ${{ secrets.FIREFLY_PASSWORD }}
      HEADLESS: "true"
      CI: "true"
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout Firefly III repository (PR code)
        uses: actions/checkout@v4

      - name: Checkout Firefly-UI (tests repo)
        uses: actions/checkout@v4
        with:
          repository: tmeraslan/firefly-UI
          path: firefly-UI

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Chrome (stable)
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          cd firefly-UI
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install "selenium>=4.13" pillow pytest pytest-timeout

      - name: Wait for Firefly to be ready
        run: |
          echo "Waiting for ${FIREFLY_URL}..."
          for i in $(seq 1 40); do
            if curl -fsSL -o /dev/null "${FIREFLY_URL}/login" || curl -fsSL -o /dev/null "${FIREFLY_URL}/api/v1/ping"; then
              echo "‚úÖ Firefly is reachable"; exit 0
            fi
            echo "Attempt $i/40: not ready, sleeping 3s..."; sleep 3
          done
          echo "‚ùå Firefly did not become ready."
          curl -I "${FIREFLY_URL}/login" || true
          exit 1

      - name: Run Selenium UI tests (headless)
        run: |
          cd firefly-UI
          pytest tests/ -v --disable-warnings --timeout=120

      - name: Upload UI artifacts (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-artifacts
          path: |
            firefly-UI/reports/**
            firefly-UI/screenshots/**
          if-no-files-found: ignore

  # === 2) receipt-parser ===
  receipt-parser-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout receipt-parser
        uses: actions/checkout@v4
        with:
          repository: tmeraslan/receipt-parser
          path: receipt-parser
          # ◊ê◊ù repo ◊§◊®◊ò◊ô: ◊î◊ï◊°◊£ token ◊¢◊ù ◊í◊ô◊©◊™ read
          # token: ${{ secrets.CI_GH_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          cd receipt-parser
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest

      - name: Run tests
        run: |
          cd receipt-parser
          pytest tests -v --disable-warnings

      - name: Upload parser artifacts (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: receipt-parser-artifacts
          path: |
            receipt-parser/.pytest_cache/**
          if-no-files-found: ignore

  # === 3) firefly API tests (auto-detect: PHP/Python/Postman/Node) ===
  firefly-api-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      FIREFLY_URL: "http://54.217.40.63:8080"
      FIREFLY_API_TOKEN: ${{ secrets.FIREFLY_API_TOKEN }}   # ◊ê◊ù ◊¶◊®◊ô◊ö ◊ò◊ï◊ß◊ü ◊ú-API
      CI: "true"
    steps:
      - name: Checkout firefly (API repo)
        uses: actions/checkout@v4
        with:
          repository: tmeraslan/firefly
          path: firefly-api
          # ◊ê◊ù repo ◊§◊®◊ò◊ô: ◊î◊ï◊°◊£ token ◊¢◊ù ◊í◊ô◊©◊™ read
          # token: ${{ secrets.CI_GH_TOKEN }}

      - name: Detect & run API tests
        run: |
          set -e
          cd firefly-api

          echo "üîé Detecting project type..."
          if [ -f composer.json ]; then
            echo "‚Üí PHP project detected"
            sudo apt-get update
            sudo apt-get install -y php-cli php-xml php-mbstring php-curl unzip
            curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
            composer install --no-interaction --prefer-dist
            if [ -x vendor/bin/pest ]; then
              vendor/bin/pest -v
            elif [ -f phpunit.xml ] || [ -f phpunit.xml.dist ]; then
              vendor/bin/phpunit --testdox
            else
              echo "‚ö†Ô∏è No PHPUnit/Pest config found; attempting vendor/bin/phpunit -v"
              vendor/bin/phpunit -v || { echo "‚ùå No PHP test runner found"; exit 1; }
            fi

          elif [ -f requirements.txt ] || ls tests/*.py >/dev/null 2>&1; then
            echo "‚Üí Python API tests detected"
            python -m pip install --upgrade pip
            if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
            pip install pytest requests
            pytest tests -v --disable-warnings

          elif [ -f package.json ]; then
            echo "‚Üí Node/Postman project detected"
            # ◊†◊†◊°◊î newman ◊ê◊ù ◊ô◊© collections, ◊ê◊ó◊®◊™ npm test
            npm ci || npm install
            if ls *.postman_collection.json >/dev/null 2>&1; then
              npm i -g newman
              # ◊ê◊ù ◊ô◊© env file:
              if ls *.postman_environment.json >/dev/null 2>&1; then
                for c in *.postman_collection.json; do
                  for e in *.p*









# name: UI Tests

# on:
#   pull_request:
#     branches: [ main ]

# permissions:
#   contents: read

# jobs:
#   ui-tests:
#     runs-on: ubuntu-latest
#     timeout-minutes: 30

#     env:
#       FIREFLY_URL: "http://54.217.40.63:8080"   # ‚Üê ◊î-URL ◊î◊ó◊ô◊¶◊ï◊†◊ô ◊©◊ú◊ö
#       EMAIL: ${{ secrets.FIREFLY_EMAIL }}
#       PASSWORD: ${{ secrets.FIREFLY_PASSWORD }}
#       HEADLESS: "true"
#       CI: "true"
#       PYTHONUNBUFFERED: "1"

#     steps:
#       - name: Checkout Firefly III repository (PR code)
#         uses: actions/checkout@v4

#       - name: Checkout Firefly-UI (tests repo)
#         uses: actions/checkout@v4
#         with:
#           repository: tmeraslan/firefly-UI
#           path: firefly-UI

#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"

#       - name: Setup Chrome (stable)
#         uses: browser-actions/setup-chrome@v1
#         with:
#           chrome-version: stable

#       - name: Install Python dependencies
#         run: |
#           python -m pip install --upgrade pip
#           cd firefly-UI
#           if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
#           pip install "selenium>=4.13" pillow pytest pytest-timeout

#       - name: Show versions (debug)
#         run: |
#           google-chrome --version || true
#           python -c "import selenium,sys; print('selenium', selenium.__version__); print(sys.version)"
#           echo "FIREFLY_URL=${FIREFLY_URL}"

#       - name: Wait for Firefly to be ready
#         run: |
#           echo "Waiting for ${FIREFLY_URL}..."
#           for i in $(seq 1 40); do
#             if curl -fsSL -o /dev/null "${FIREFLY_URL}/login" || curl -fsSL -o /dev/null "${FIREFLY_URL}/api/v1/ping"; then
#               echo "‚úÖ Firefly is reachable"
#               exit 0
#             fi
#             echo "Attempt $i/40: not ready, sleeping 3s..."
#             sleep 3
#           done
#           echo "‚ùå Firefly did not become ready."
#           curl -I "${FIREFLY_URL}/login" || true
#           exit 1

#       - name: Run Selenium UI tests (headless)
#         run: |
#           cd firefly-UI
#           pytest tests/ -v --disable-warnings --timeout=120

#       - name: Upload test artifacts (optional)
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: ui-test-artifacts
#           path: |
#             firefly-UI/reports/**
#             firefly-UI/screenshots/**
#           if-no-files-found: ignore
